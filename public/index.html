<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ai chatbot</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap');

        * {
            margin: 0;
            padding: 0;
        }

        body {
            background: #181818;
            font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .aibot {
            margin-top: -40px;
            border-radius: 20px;
            width: 350px;
            height: 450px;
            background: #363636;
            padding: 10px;
            box-shadow: 0 1px 6px rgba(100, 100, 100, 0.5);
        }

        .aibot .chat {
            height: 80%;
            background: #424242;
            border-radius: inherit;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow-y: auto;
            padding: 10px;
        }

        .aibot .chat .robot {
            position: absolute;
            width: 90%;
            height: 90%;
        }

        .aibot .chat .robot h2 {
            text-align: center;
            margin-top: -70px;
        }

        .aibot .chat .robot p {
            font-size: 14px;
            font-family: roboto;
            text-align: center;
            color: #6e6e6e;
        }

        .aibot .chat::-webkit-scrollbar {
            width: 6px;
        }
        .aibot .chat::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 10px;
        }

        .text-collor-effect {
            background: linear-gradient(to right, rgb(49, 232, 245), #8308d4, #8a21ec, #6070fd, #3950e7, rgb(49, 232, 245));
            background-repeat: repeat;
            -webkit-background-clip: text;
            background-clip: text;
            background-size: 200%;
            -webkit-text-fill-color: transparent;
            animation: text 3s linear infinite;
            font-weight: bold;
        }

        @keyframes text {
            100% {
                background-position: 100%;
            }
        }

        .aibot .chat .robot video {
            width: 100%;
            height: 100%;
            mix-blend-mode: lighten;
        }

        .aibot .input {
            margin-top: 10px;
            width: 100%;
            display: flex;
        }

        .aibot .input input {
            width: calc(80% - 10px);
            height: 40px;
            border-radius: 20px;
            background: #424242;
            border: none;
            outline: none;
            padding: 0 10px;
            color: #ffff;
        }

        .aibot .input .videodiv {
            width: 120px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            margin-right: -20px;
            margin-top: -23px;

        }

        .aibot .input .videodiv video {
            position: relative;
            z-index: 99999;
            height: 90px;
            width: 120px;
            mix-blend-mode: lighten;

        }

        .aibot .chat .user-input,
        .aibot .chat .aibot-output {
            width: 100%;
            height: 100%;
        }

        .aibot .chat .aibot-output {

            display: flex;
            justify-content: left;
        }

        .aibot .chat .user-input {

            display: flex;
            justify-content: right;
        }

        .chat-message {
            min-width: 85%;
        }

        .chat-messages {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message.user {
            align-self: flex-end;
            background: purple;
            color: #fff;
            padding: 10px 16px;
            border-radius: 999px;
            max-width: 85%;
            font-size: 13px;
        }

        .message.bot {
            align-self: flex-start;
            background: #363636;
            color: #fff;
            padding: 10px 16px;
            border-radius: 18px;
            max-width: 85%;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
            position: relative;
        }

        .message.bot::after {
            content: '▌';
            animation: blink 1s infinite;
        }

        @keyframes blink {
            50% { opacity: 0; }
        }

        #inputmessage {
            margin-right: 20px;
            margin-top: 20px;
            color: #fff;
            background: purple;
            height: fit-content;
            padding: 10px 20px;
            border-radius: 99999px;
            opacity: 0;
            transition: .3s ease-out;
        }

        #outputmessage {
            margin-left: 10px;
            text-wrap: wrap;
            margin-top: 20px;
            color: #fff;
            background: #363636;
            height: fit-content;
            padding: 10px 20px;
            border-radius: 20px;
            opacity: 0;
            font-size: 12px;
            transition: .3s ease-out;
            font-family: 'roboto', sans-serif;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-width: 90%;
        }

        @keyframes typing {
            from {
                width: 0
            }
            to {
                width: 100%
            }
        }

    </style>
</head>
<body>
    <div class="aibot">
        <div id="credits" style="
            color:#00eaff;
            font-size:12px;
            text-align:center;
            margin-bottom:6px;
            font-family:roboto;
            ">
            Crediti rimasti: 20
        </div>

        <div id="warning" style="
            color:#ff9800;
            font-size:12px;
            text-align:center;
            display:none;
            font-family:roboto;
            ">
        </div>

        <div class="chat">
            <div class="chat-messages" id="chatMessages"></div>

            <div class="robot" id="robot">
                <video muted autoplay loop plays-inline src="robot.mp4"></video>
                <h2 class="text-collor-effect">Chiedi qualcosa a Dalzi Ai</h2>
                <p>L'intelligenza artificiale di Dalzi. Da utilizzare con rispetto delle normative vigenti.</p>
            </div>
        </div>

        <div class="input">
            
        <input type="text" id="usermessage" spellcheck="false" placeholder="Chiedi qualcosa a Dalzi Ai">
        <div class="videodiv">
            <video muted autoplay loop src="ezgif-73b7f6ac862004.mp4"></video>
        </div>
        </div>
    </div>

    <script>
        const input = document.getElementById('usermessage');
        const chatMessages = document.getElementById('chatMessages');
        const creditsDiv = document.getElementById('credits');
        const warningDiv = document.getElementById('warning');
        const chat = document.querySelector('.chat');

        function addMessage(text, type) {
            const msg = document.createElement('div');
            msg.classList.add('message', type);
            chatMessages.appendChild(msg);

            chat.scrollTop = chat.scrollHeight;

            if (type === 'bot') {
                const speed = text.length > 300 ? 10 : 20;

                typeMessage(text, msg, speed);
            } else {
                msg.textContent = text;
            }
        }

        input.addEventListener('keypress', async function (e) {
            if (e.key === 'Enter' && input.value.trim() !== '') {
                const userMsg = input.value;
                const lowerMsg = userMsg.toLowerCase(); // Trasforma in minuscolo per il controllo
                input.value = '';

                document.getElementById('robot').style.display = 'none';

                addMessage(userMsg, 'user');

                // --- INIZIO LOGICA PERSONALIZZATA ---
                if (lowerMsg.includes("chi ti ha creato") || lowerMsg.includes("chi è il tuo creatore")) {
                    addMessage("Mi ha creato Dalzi", 'bot');
                    return; // Blocca l'esecuzione qui e non invia la richiesta al server
                }
                // --- FINE LOGICA PERSONALIZZATA ---

                try {
                    const res = await fetch('/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: userMsg })
                    });

                    const data = await res.json();
                    addMessage(data.reply, 'bot');

                    if (data.creditsLeft !== undefined) {
                        creditsDiv.innerText = `Crediti rimasti: ${data.creditsLeft}`;
                    }

                    if (data.warning) {
                        warningDiv.style.display = 'block';
                        warningDiv.innerText = data.warning;
                    }

                } catch (err) {
                    addMessage('Errore nella connessione al server.', 'bot');
                }
            }
        });

        function typeMessage(text, element, speed = 20) {
            let i = 0;
            element.textContent = '';

            const interval = setInterval(() => {
                element.textContent += text.charAt(i);
                i++;

                chat.scrollTop = chat.scrollHeight;

                if (i >= text.length) {
                    clearInterval(interval);
                }
            }, speed);
        }

    </script>
</body>
</html>